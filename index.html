<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEI PMO Report ‚Äî Live</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style>
  :root{--navy:#375673;--green:#779d36;--amber:#e8a930;--red:#e05252;--bg:#f5f7fa;--sidebar-w:240px;}
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Barlow',sans-serif;background:var(--bg);color:#1a1a1a;}

  /* Layout */
  .app-layout{display:flex;min-height:100vh;}

  /* Sidebar */
  .sidebar{width:var(--sidebar-w);background:linear-gradient(180deg,#2d4a63 0%,#1e3548 100%);color:#fff;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform 0.2s;}
  .sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid rgba(255,255,255,0.08);}
  .sidebar-logo h1{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;display:flex;align-items:center;gap:8px;}
  .sidebar-logo h1 span{color:#a8c76a;}
  .sidebar-logo .sub{font-size:11px;color:rgba(255,255,255,0.35);font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;}
  .sidebar-nav{flex:1;overflow-y:auto;padding:12px 0;}
  .sidebar-section{padding:0 16px;margin-bottom:16px;}
  .sidebar-section-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,0.3);padding:8px 8px 6px;display:flex;align-items:center;gap:6px;}
  .sidebar-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;font-size:13px;font-weight:600;color:rgba(255,255,255,0.65);cursor:pointer;transition:all 0.15s;margin-bottom:2px;position:relative;}
  .sidebar-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.9);}
  .sidebar-item.active{background:var(--green);color:#fff;}
  .sidebar-item .icon{font-size:16px;width:22px;text-align:center;flex-shrink:0;}
  .sidebar-item .badge{position:absolute;right:10px;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;}
  .sidebar-divider{height:1px;background:rgba(255,255,255,0.06);margin:8px 16px;}
  .sidebar-user{padding:16px 20px;border-top:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.1);}
  .sidebar-user-role{display:inline-block;padding:3px 10px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
  .sidebar-user-role.admin{background:var(--green);color:#fff;}
  .sidebar-user-name{font-size:14px;font-weight:700;color:#fff;}
  .sidebar-user-email{font-size:11px;color:rgba(255,255,255,0.45);margin-top:1px;}
  .sidebar-signout{display:block;width:100%;margin-top:12px;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.6);font-family:'Barlow',sans-serif;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all 0.15s;}
  .sidebar-signout:hover{background:rgba(255,255,255,0.08);color:#fff;border-color:rgba(255,255,255,0.3);}
  .sidebar-projects{max-height:40vh;overflow-y:auto;}
  .sidebar-proj{display:flex;align-items:center;gap:8px;padding:7px 12px;border-radius:6px;font-size:12px;font-weight:600;color:rgba(255,255,255,0.55);cursor:pointer;transition:all 0.15s;margin-bottom:1px;}
  .sidebar-proj:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.85);}
  .sidebar-proj.active{background:rgba(119,157,54,0.2);color:#a8c76a;}
  .sidebar-proj .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
  .sidebar-proj .pname{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .sidebar-proj .ppct{font-size:10px;font-weight:700;color:rgba(255,255,255,0.35);}

  /* Main content area */
  .main-area{margin-left:var(--sidebar-w);flex:1;min-height:100vh;}
  .container{max-width:1400px;margin:0 auto;padding:20px 24px;}

  /* Login card */
  .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);}
  .login-card{background:#fff;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.08);width:420px;overflow:hidden;}
  .login-card-head{padding:32px 32px 24px;text-align:center;}
  .login-card-logo{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--navy);margin-bottom:4px;}
  .login-card-logo span{color:var(--green);}
  .login-card-sub{font-size:13px;color:#8a9baa;}
  .login-card-body{padding:0 32px 32px;}
  .login-card-divider{height:1px;background:#e2e8f0;margin-bottom:24px;}
  .login-card-ms{width:100%;padding:14px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;font-family:'Barlow',sans-serif;font-size:14px;font-weight:600;color:#1a1a1a;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.15s;}
  .login-card-ms:hover{border-color:#0078d4;background:#f8fbff;box-shadow:0 2px 8px rgba(0,120,212,0.1);}
  .login-card-ms svg{flex-shrink:0;}
  .login-card-footer{padding:16px 32px;background:#fafbfc;border-top:1px solid #e2e8f0;text-align:center;font-size:11px;color:#b0bac4;}

  .loading{text-align:center;padding:60px;color:#8a9baa;font-size:14px;}
  .loading .spinner{display:inline-block;width:24px;height:24px;border:3px solid #e2e8f0;border-top-color:var(--green);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px;}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Project Tabs */
  .proj-tabs{display:flex;gap:6px;overflow-x:auto;padding:16px 0;border-bottom:1px solid #e2e8f0;margin-bottom:20px;}
  .proj-tab{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;border:1px solid #e2e8f0;background:#fff;color:#4a5568;transition:all 0.15s;}
  .proj-tab:hover{border-color:var(--green);color:var(--green);}
  .proj-tab.active{background:var(--green);color:#fff;border-color:var(--green);}

  /* Search + Add */
  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap;}
  .search-box{padding:8px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;width:280px;font-family:'Barlow',sans-serif;background:#fff;}
  .search-box:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 2px rgba(119,157,54,0.1);}
  .add-proj-btn{padding:8px 18px;border-radius:8px;border:none;background:linear-gradient(135deg,#779d36,#5f8228);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;}
  .add-proj-btn:hover{filter:brightness(1.1);}
  .sync-status{font-size:11px;color:#8a9baa;margin-left:auto;}
  .sync-status.syncing{color:var(--amber);}
  .sync-status.error{color:var(--red);}

  /* Category sections */
  .cat-section{margin-bottom:16px;background:#fff;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;}
  .cat-header{padding:12px 20px;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none;}
  .cat-header:hover{opacity:0.9;}
  .cat-chevron{font-size:12px;transition:transform 0.2s;color:rgba(255,255,255,0.7);}
  .cat-header.collapsed .cat-chevron{transform:rotate(-90deg);}
  .cat-body{display:grid;grid-template-columns:1fr 1fr;border-top:1px solid rgba(0,0,0,0.05);}
  .cat-body.hidden{display:none;}

  /* Topic rows */
  .topic-row{display:grid;grid-template-columns:36px 1fr 30px;border-bottom:1px solid #f0f4f8;border-right:1px solid #f0f4f8;min-height:40px;align-items:stretch;}
  .topic-row:last-child{border-bottom:none;}
  .topic-label{padding:6px 10px;font-size:12px;font-weight:600;color:var(--navy);background:#fafbfc;border-bottom:1px solid #f0f4f8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .topic-val{padding:4px 8px;font-size:13px;color:#4a5568;position:relative;}
  .topic-check{display:flex;align-items:center;justify-content:center;padding:6px 4px;border-right:1px solid #f0f4f8;background:#fafbfc;cursor:pointer;}
  .topic-check input[type="checkbox"]{width:16px;height:16px;cursor:pointer;accent-color:var(--green);margin:0;}
  .topic-row.completed .topic-label{color:#8a9baa;text-decoration:line-through;text-decoration-color:#c4d0dc;}
  .topic-row.completed .topic-val textarea{color:#b0bac4;}
  .topic-val textarea{width:100%;border:1px solid transparent;background:transparent;font-family:'Barlow',sans-serif;font-size:12px;color:#4a5568;resize:none;overflow:hidden;min-height:22px;padding:3px 6px;border-radius:4px;line-height:1.4;transition:all 0.15s;}
  .topic-val textarea:hover{border-color:#e2e8f0;background:#fff;}
  .topic-val textarea:focus{border-color:var(--green);background:#fff;outline:none;box-shadow:0 0 0 2px rgba(119,157,54,0.15);}
  .topic-val textarea.empty{color:#c4d0dc;font-style:italic;}

  /* Comment button */
  .comment-btn{display:flex;align-items:center;justify-content:center;cursor:pointer;color:#c4d0dc;background:#fafbfc;transition:color 0.15s;padding:0 4px;border-left:1px solid #f0f4f8;font-size:12px;}
  .comment-btn:hover{color:var(--navy);}
  .comment-btn.has-comments{color:var(--green);}

  /* Comment panel */
  .comment-panel{position:fixed;right:0;top:0;width:380px;height:100vh;background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,0.1);z-index:300;display:flex;flex-direction:column;animation:slideIn 0.2s ease-out;}
  @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
  .comment-panel-head{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;}
  .comment-panel-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:var(--navy);}
  .comment-panel-topic{font-size:12px;color:#8a9baa;margin-top:2px;}
  .comment-close{background:none;border:none;font-size:20px;cursor:pointer;color:#8a9baa;padding:4px 8px;border-radius:4px;}.comment-close:hover{background:#f0f4f8;}
  .comment-list{flex:1;overflow-y:auto;padding:16px 20px;}
  .comment-item{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #f0f4f8;}
  .comment-item:last-child{border-bottom:none;}
  .comment-author{font-size:12px;font-weight:700;color:var(--navy);}
  .comment-time{font-size:10px;color:#b0bac4;margin-left:8px;}
  .comment-text{font-size:13px;color:#4a5568;margin-top:4px;line-height:1.5;}
  .comment-text .mention{color:var(--green);font-weight:600;}
  .comment-input-area{padding:16px 20px;border-top:1px solid #e2e8f0;position:relative;}
  .comment-input{width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-family:'Barlow',sans-serif;font-size:13px;resize:none;min-height:60px;line-height:1.4;}
  .comment-input:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 2px rgba(119,157,54,0.15);}
  .comment-send{margin-top:8px;padding:8px 16px;border-radius:6px;border:none;background:var(--green);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;cursor:pointer;float:right;}
  .comment-send:hover{filter:brightness(1.1);}
  .comment-send:disabled{opacity:0.5;cursor:not-allowed;}

  /* Mention autocomplete */
  .mention-dropdown{position:absolute;bottom:100%;left:20px;right:20px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 -4px 16px rgba(0,0,0,0.08);max-height:200px;overflow-y:auto;display:none;z-index:10;}
  .mention-dropdown.show{display:block;}
  .mention-item{padding:8px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;transition:background 0.1s;}
  .mention-item:hover,.mention-item.selected{background:rgba(119,157,54,0.08);}
  .mention-avatar{width:28px;height:28px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;}
  .mention-name{font-weight:600;color:var(--navy);}
  .mention-email{font-size:11px;color:#8a9baa;}

  /* Category colors */
  .cat-general{background:linear-gradient(135deg,#375673,#2d4a63);color:#fff;}
  .cat-permitting{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;}
  .cat-engineering{background:linear-gradient(135deg,#779d36,#5f8228);color:#fff;}
  .cat-procurement{background:linear-gradient(135deg,#e8a930,#d49a20);color:#fff;}
  .cat-construction{background:linear-gradient(135deg,#e05252,#c0392b);color:#fff;}
  .cat-milestones{background:linear-gradient(135deg,#2ecc8a,#27ae60);color:#fff;}
  .cat-finance{background:linear-gradient(135deg,#0078d4,#0060aa);color:#fff;}

  .toast{position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:8px;font-weight:600;font-size:13px;opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:400;box-shadow:0 4px 12px rgba(0,0,0,0.15);color:#fff;}
  .toast.show{opacity:1;}
  .toast.ok{background:var(--green);}
  .toast.err{background:var(--red);}
  .toast.info{background:var(--navy);}

  .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:290;}

  /* KPI Dashboard */
  .kpi-dash{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:20px;}
  .kpi-card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;transition:transform 0.15s,box-shadow 0.15s;}
  .kpi-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.06);}
  .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
  .kpi-card.kpi-overall::before{background:linear-gradient(90deg,var(--green),var(--amber));}
  .kpi-card.kpi-cat::before{background:var(--navy);}
  .kpi-card.kpi-general::before{background:linear-gradient(90deg,#375673,#2d4a63);}
  .kpi-card.kpi-permitting::before{background:linear-gradient(90deg,#7c3aed,#6d28d9);}
  .kpi-card.kpi-engineering::before{background:linear-gradient(90deg,#779d36,#5f8228);}
  .kpi-card.kpi-procurement::before{background:linear-gradient(90deg,#e8a930,#d49a20);}
  .kpi-card.kpi-construction::before{background:linear-gradient(90deg,#e05252,#c0392b);}
  .kpi-card.kpi-milestones::before{background:linear-gradient(90deg,#2ecc8a,#27ae60);}
  .kpi-card.kpi-finance::before{background:linear-gradient(90deg,#0078d4,#0060aa);}
  .kpi-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#8a9baa;margin-bottom:6px;}
  .kpi-value{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;color:var(--navy);line-height:1;}
  .kpi-sub{font-size:12px;color:#8a9baa;margin-top:4px;}
  .kpi-bar-track{height:6px;background:#e9edf2;border-radius:3px;margin-top:10px;overflow:hidden;}
  .kpi-bar-fill{height:100%;border-radius:3px;transition:width 0.6s ease-out;}
  .kpi-bar-fill.green{background:linear-gradient(90deg,#779d36,#5f8228);}
  .kpi-bar-fill.amber{background:linear-gradient(90deg,#e8a930,#d49a20);}
  .kpi-bar-fill.red{background:linear-gradient(90deg,#e05252,#c0392b);}
  .kpi-bar-fill.done{background:linear-gradient(90deg,#2ecc8a,#27ae60);}
  .kpi-big-ring{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;position:relative;}
  .kpi-big-ring svg{transform:rotate(-90deg);}
  .kpi-big-pct{position:absolute;font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--navy);}
  .kpi-portfolio{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:14px;}
  .kpi-proj-mini{background:#fafbfc;border:1px solid #e9edf2;border-radius:8px;padding:10px 12px;text-align:center;cursor:pointer;transition:all 0.15s;}
  .kpi-proj-mini:hover{border-color:var(--green);background:#f0faf0;}
  .kpi-proj-mini.active{border-color:var(--green);background:#f0faf0;box-shadow:0 0 0 2px rgba(119,157,54,0.15);}
  .kpi-proj-name{font-size:11px;font-weight:700;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .kpi-proj-pct{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;margin-top:2px;}
  .kpi-proj-bar{height:4px;background:#e9edf2;border-radius:2px;margin-top:6px;overflow:hidden;}
  .kpi-proj-bar-fill{height:100%;border-radius:2px;transition:width 0.4s;}
  .kpi-toggle{display:flex;gap:4px;margin-bottom:14px;}
  .kpi-toggle-btn{padding:6px 14px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;font-family:'Barlow',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:#4a5568;transition:all 0.15s;}
  .kpi-toggle-btn.active{background:var(--navy);color:#fff;border-color:var(--navy);}

  /* Modal */
  .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:400;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.15s;}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .modal{background:#fff;border-radius:12px;width:480px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.2);animation:slideUp 0.2s ease-out;}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-head{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;}
  .modal-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--navy);}
  .modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:#8a9baa;padding:4px 8px;border-radius:4px;}.modal-close:hover{background:#f0f4f8;}
  .modal-body{padding:24px;overflow-y:auto;max-height:60vh;}
  .modal-footer{padding:16px 24px;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;gap:8px;}
  .form-group{margin-bottom:16px;}
  .form-label{display:block;font-size:12px;font-weight:700;color:#8a9baa;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;}
  .form-input{width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-family:'Barlow',sans-serif;font-size:14px;transition:all 0.15s;}
  .form-input:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 2px rgba(119,157,54,0.15);}
  .form-hint{font-size:11px;color:#b0bac4;margin-top:4px;}
  .btn-cancel{padding:8px 18px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;color:#4a5568;font-family:'Barlow',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}.btn-cancel:hover{background:#f8fafb;}
  .btn-create{padding:8px 18px;border-radius:6px;border:none;background:linear-gradient(135deg,#779d36,#5f8228);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}.btn-create:hover{filter:brightness(1.1);}.btn-create:disabled{opacity:0.5;cursor:not-allowed;}
  .btn-delete{padding:8px 18px;border-radius:6px;border:none;background:linear-gradient(135deg,#e05252,#c0392b);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}.btn-delete:hover{filter:brightness(1.1);}.btn-delete:disabled{opacity:0.5;cursor:not-allowed;}
  .del-proj-btn{padding:8px 14px;border-radius:8px;border:1px solid #e05252;background:#fff;color:#e05252;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.15s;}
  .del-proj-btn:hover{background:#e05252;color:#fff;}
  .var-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
  .var-tag{padding:4px 10px;border-radius:16px;font-size:11px;font-weight:600;background:#f0f4f8;color:#4a5568;border:1px solid #e2e8f0;display:flex;align-items:center;gap:4px;}
  .var-tag .x{cursor:pointer;color:#b0bac4;font-size:14px;line-height:1;}.var-tag .x:hover{color:var(--red);}
  .var-add-row{display:flex;gap:6px;margin-top:8px;}
  .var-add-input{flex:1;padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;font-family:'Barlow',sans-serif;}.var-add-input:focus{outline:none;border-color:var(--green);}
  .var-add-btn{padding:6px 12px;border-radius:6px;border:none;background:var(--green);color:#fff;font-size:12px;font-weight:700;cursor:pointer;}
</style>
</head>
<body>

<!-- Login Screen (shown before auth) -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="login-card-head">
      <div class="login-card-logo">DEI <span>PMO Report</span></div>
      <div class="login-card-sub">Project Management Office ‚Äî Live Dashboard</div>
    </div>
    <div class="login-card-body">
      <div class="login-card-divider"></div>
      <button class="login-card-ms" onclick="doLogin()">
        <svg width="20" height="20" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#F25022"/><rect x="11" y="1" width="9" height="9" fill="#7FBA00"/><rect x="1" y="11" width="9" height="9" fill="#00A4EF"/><rect x="11" y="11" width="9" height="9" fill="#FFB900"/></svg>
        Sign in with Microsoft
      </button>
    </div>
    <div class="login-card-footer">Connected to SharePoint ¬∑ Real-time read/write</div>
  </div>
</div>

<!-- App Layout (shown after auth) -->
<div id="appLayout" class="app-layout" style="display:none;">

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a8c76a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z'%3E%3C/path%3E%3C/svg%3E" alt="" style="width:20px;height:20px;">
        <h1>DEI</h1>
      </div>
      <div class="sub">Project Truth ‚Äî PMO</div>
    </div>

    <div class="sidebar-nav">
      <div class="sidebar-section">
        <div class="sidebar-section-label">Dashboard</div>
        <div class="sidebar-item active" onclick="setSidebarView('overview')">
          <span class="icon">üìä</span> Overview
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Projects</div>
        <div id="sidebarProjects" class="sidebar-projects"></div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Logs</div>
        <div class="sidebar-item" onclick="setSidebarView('rfi')">
          <span class="icon">üìù</span> RFI &amp; Submittal Log
        </div>
        <div class="sidebar-item" onclick="setSidebarView('cost')">
          <span class="icon">üí∞</span> Cost
        </div>
        <div class="sidebar-item" onclick="setSidebarView('progress')">
          <span class="icon">üìà</span> Progress
        </div>
      </div>

      <div class="sidebar-divider"></div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Admin</div>
        <div class="sidebar-item" onclick="setSidebarView('settings')">
          <span class="icon">‚öôÔ∏è</span> Settings
        </div>
      </div>
    </div>

    <div class="sidebar-user">
      <div class="sidebar-user-role admin" id="userRole">ADMIN</div>
      <div class="sidebar-user-name" id="sidebarUserName">‚Äî</div>
      <div class="sidebar-user-email" id="sidebarUserEmail">‚Äî</div>
      <button class="sidebar-signout" onclick="doSignOut()">Sign out</button>
    </div>
  </nav>

  <!-- Main -->
  <div class="main-area">
    <div class="container">
      <div id="mainContent">
        <div class="loading"><div class="spinner"></div><br>Loading PMO data from SharePoint...</div>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>
<div id="addProjectModal" style="display:none;"></div>
<div id="commentPanel"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
  clientId: "613928f8-0497-47ea-bb0f-c1725a1f156a",
  tenantId: "ec357a32-5b85-438d-a765-ae33c8eb13b7",
  siteId: "8103997e-0688-4832-a5b4-bf18de7f96f5",
  listId: "c0443281-dca9-49e0-856f-2748d4681399"
};
const SITE = "/sites/" + CONFIG.siteId;
const LIST = SITE + "/lists/" + CONFIG.listId;
const SCOPES = ["Sites.Manage.All", "Sites.Selected", "User.Read", "Chat.Create", "Chat.ReadWrite", "User.ReadBasic.All"];
const REDIRECT = window.location.origin + window.location.pathname;

const TEAM = [{"name": "Joshua Dean", "email": "jdean@distributedei.com", "nick": "Joshua"}, {"name": "Tom Guinta", "email": "tguinta@distributedei.com", "nick": "Tom"}, {"name": "Beth Harrington", "email": "bharrington@distributedei.com", "nick": "Beth"}, {"name": "Steve Maslen", "email": "smaslen@distributedei.com", "nick": "Steve"}, {"name": "David Moulton", "email": "dmoulton@distributedei.com", "nick": "David M"}, {"name": "Jessica Morse", "email": "jmorse@distributedei.com", "nick": "Jessica"}, {"name": "Daniel Spaizman", "email": "dspaizman@distributedei.com", "nick": "Daniel"}, {"name": "Jonas Bukh", "email": "jbukh@distributedei.com", "nick": "Jonas"}, {"name": "John Daly", "email": "jdaly@distributedei.com", "nick": "John"}, {"name": "Brian Follo", "email": "bfollo@distributedei.com", "nick": "Brian F"}, {"name": "Eli Cayer", "email": "ecayer@distributedei.com", "nick": "Eli"}, {"name": "Jackson Elwell", "email": "jelwell@distributedei.com", "nick": "Jackson"}, {"name": "Corinne Scanlon", "email": "cscanlon@distributedei.com", "nick": "Corinne"}, {"name": "Joshua Kuntz", "email": "jkuntz@distributedei.com", "nick": "Josh K"}, {"name": "Mike Wilkinson", "email": "mwilkinson@distributedei.com", "nick": "Mike W"}, {"name": "Matthew Sowle", "email": "msowle@distributedei.com", "nick": "Matt"}, {"name": "Caleb Schott", "email": "cschott@distributedei.com", "nick": "Caleb"}, {"name": "Stowe Duston", "email": "sduston@distributedei.com", "nick": "Stowe"}, {"name": "Thomas Hewitt", "email": "thewitt@distributedei.com", "nick": "Thomas"}, {"name": "Chris Shepard", "email": "cshepard@distributedei.com", "nick": "Chris"}, {"name": "Dipti Kothari", "email": "dkothari@distributedei.com", "nick": "Dipti"}, {"name": "Rusfid Haroon", "email": "rharoon@distributedei.com", "nick": "Rusfid"}, {"name": "Gabriel Murray", "email": "gmurray@distributedei.com", "nick": "Gabe"}, {"name": "David Caparelli", "email": "dcaparelli@distributeder.com", "nick": "David C"}, {"name": "Prateek Tare", "email": "ptare@distributeder.com", "nick": "Prateek"}, {"name": "Sean Harrington", "email": "sharrington@distributeder.com", "nick": "Sean"}, {"name": "Adam Regen", "email": "aregen@distributeder.com", "nick": "Adam"}, {"name": "Laura Gilman-Boutot", "email": "lgilman-boutot@distributeder.com", "nick": "Laura"}, {"name": "Trevor Maclachlan", "email": "tmaclachlan@distributeder.com", "nick": "Trevor"}, {"name": "Ryan Harrington", "email": "rharrington@distributeder.com", "nick": "Ryan"}, {"name": "Brian Parker", "email": "bparker@distributeder.com", "nick": "Brian P"}, {"name": "Joot Wright", "email": "jwright@distributeder.com", "nick": "Joot"}, {"name": "Alyssa DeBell", "email": "adebell@distributeder.com", "nick": "Alyssa"}, {"name": "David Sieczarski", "email": "dsieczarski@distributeder.com", "nick": "David S"}, {"name": "Carlton Tobler", "email": "ctobler@distributeder.com", "nick": "Carlton"}, {"name": "Peter Stanford", "email": "pstanford@distributeder.com", "nick": "Peter"}, {"name": "Alan Derosier", "email": "aderosier@distributeder.com", "nick": "Alan"}, {"name": "Ian Maclachlan", "email": "imaclachlan@distributeder.com", "nick": "Ian"}, {"name": "Julian Diaz", "email": "jdiaz@distributeder.com", "nick": "Julian"}];

const CATEGORIES = ["General", "Permitting", "Engineering", "Procurement (Subcontractors)", "Construction", "Milestones", "Finance"];
const CAT_CLASSES = {"General":"cat-general","Permitting":"cat-permitting","Engineering":"cat-engineering","Procurement (Subcontractors)":"cat-procurement","Construction":"cat-construction","Milestones":"cat-milestones","Finance":"cat-finance"};
const CAT_ICONS = {"General":"üìã","Permitting":"üèõ","Engineering":"‚öôÔ∏è","Procurement (Subcontractors)":"üî®","Construction":"üèóÔ∏è","Milestones":"üéØ","Finance":"üí∞"};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const msalInstance = new msal.PublicClientApplication({
  auth: { clientId: CONFIG.clientId, authority: "https://login.microsoftonline.com/" + CONFIG.tenantId, redirectUri: REDIRECT, navigateToLoginRequestUrl: true },
  cache: { cacheLocation: "sessionStorage" }
});

let account = null;
let DATA = [];
let spItemMap = {}; // key -> SP item id
let selProject = null;
let searchQ = "";
let collapsed = {};
let openComment = null; // {project, category, topic, itemId}
let comments = {}; // itemId -> [{author, text, time}]
let saveTimers = {};
let currentUser = null;

async function initAuth() {
  try {
    await msalInstance.initialize();
    const resp = await msalInstance.handleRedirectPromise();
    if (resp) { account = resp.account; }
    else {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length) account = accounts[0];
    }
    if (account) {
      currentUser = account.name;
      // Switch from login screen to app layout
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("appLayout").style.display = "flex";
      // Populate sidebar user info
      document.getElementById("sidebarUserName").textContent = account.name || "User";
      document.getElementById("sidebarUserEmail").textContent = account.username || "";
      loadFromSharePoint();
    }
  } catch (e) { console.error("Init:", e); }
}

async function doLogin() {
  try { await msalInstance.loginRedirect({ scopes: SCOPES }); } catch (e) { showToast("Login failed: " + e.message, "err"); }
}

function doSignOut() {
  msalInstance.logoutRedirect({ postLogoutRedirectUri: REDIRECT });
}

let sidebarView = 'overview';
function setSidebarView(view) {
  sidebarView = view;
  document.querySelectorAll('.sidebar-item').forEach(function(el) { el.classList.remove('active'); });
  if (event && event.currentTarget) event.currentTarget.classList.add('active');

  if (view === 'rfi') {
    // Link to the V3 RFI/Submittal tracker
    window.open('https://distributedei.github.io/dei-project-truth-v3/', '_blank');
    return;
  }
  if (view === 'overview') {
    renderAll();
    return;
  }
  // Placeholder for future views
  showToast(view.charAt(0).toUpperCase() + view.slice(1) + " ‚Äî coming soon", "info");
}

async function getToken() {
  try { return (await msalInstance.acquireTokenSilent({ scopes: SCOPES, account })).accessToken; }
  catch (e) { await msalInstance.acquireTokenRedirect({ scopes: SCOPES }); }
}

async function graph(method, path, body) {
  const token = await getToken();
  const opts = { method: method || "GET", headers: { Authorization: "Bearer " + token } };
  if (body) { opts.headers["Content-Type"] = "application/json"; opts.body = JSON.stringify(body); }
  const r = await fetch("https://graph.microsoft.com/v1.0" + path, opts);
  if (!r.ok) {
    let msg = "HTTP " + r.status;
    try { const e = await r.json(); msg = e.error?.message || msg; } catch(x) {}
    throw new Error(msg);
  }
  return r.status === 204 ? null : r.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD DATA FROM SHAREPOINT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFromSharePoint() {
  document.getElementById("mainContent").innerHTML = '<div class="loading"><div class="spinner"></div><br>Loading PMO data from SharePoint...</div>';
  DATA = [];
  spItemMap = {};

  try {
    // Ensure Complete column exists
    try {
      await graph("POST", LIST + "/columns", { name: "Complete", displayName: "Complete", boolean: {} });
      console.log("Complete column created");
    } catch(e) { console.log("Complete column exists or error:", e.message); }

    let url = LIST + "/items?$expand=fields&$top=999";
    let page = 0;
    while (url) {
      const resp = await graph("GET", url);
      if (resp.value) {
        resp.value.forEach(item => {
          const f = item.fields;
          const row = {
            id: item.id,
            Project: f.Project || "",
            Category: f.Category || "",
            Topic: f.Topic || "",
            Value: f.Value || "",
            SortOrder: f.SortOrder || 0,
            Complete: f.Complete === true || f.Complete === "true"
          };
          DATA.push(row);
          spItemMap[row.Project + "|" + row.Category + "|" + row.Topic] = item.id;
        });
      }
      url = resp["@odata.nextLink"] ? resp["@odata.nextLink"].replace("https://graph.microsoft.com/v1.0", "") : null;
      page++;
    }

    // Determine projects from data
    const projects = [...new Set(DATA.map(r => r.Project))].filter(Boolean).sort();
    selProject = projects[0];
    showToast("Loaded " + DATA.length + " items from SharePoint", "ok");
    renderAll(projects);
  } catch (e) {
    document.getElementById("mainContent").innerHTML = '<div class="loading" style="color:var(--red);">Failed to load: ' + e.message + '</div>';
    showToast("Load failed: " + e.message, "err");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE TO SHAREPOINT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function queueSave(itemId, field, value) {
  const key = itemId + "_" + field;
  clearTimeout(saveTimers[key]);
  saveTimers[key] = setTimeout(() => doSave(itemId, field, value), 800);
  setSyncStatus("syncing");
}

async function doSave(itemId, field, value) {
  try {
    const body = {};
    body[field] = value;
    await graph("PATCH", LIST + "/items/" + itemId + "/fields", body);
    setSyncStatus("saved");
  } catch (e) {
    setSyncStatus("error", e.message);
  }
}

function setSyncStatus(state, msg) {
  const el = document.getElementById("syncStatus");
  if (!el) return;
  if (state === "syncing") { el.textContent = "‚ü≥ Saving..."; el.className = "sync-status syncing"; }
  else if (state === "saved") { el.textContent = "‚úì Saved to SharePoint"; el.className = "sync-status"; setTimeout(() => { if (el.textContent.includes("Saved")) el.textContent = ""; }, 2000); }
  else if (state === "error") { el.textContent = "‚úó Save failed: " + (msg || ""); el.className = "sync-status error"; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let kpiView = 'project'; // 'project' or 'portfolio'

function getCompletionStats(project, category) {
  const items = DATA.filter(r => (!project || r.Project === project) && (!category || r.Category === category));
  const total = items.length;
  const done = items.filter(r => r.Complete).length;
  const pct = total > 0 ? Math.round((done / total) * 100) : 0;
  return { total, done, pct };
}

function barColor(pct) {
  if (pct >= 100) return 'done';
  if (pct >= 60) return 'green';
  if (pct >= 30) return 'amber';
  return 'red';
}

function ringSVG(pct, size, stroke, color) {
  const r = (size - stroke) / 2;
  const circ = 2 * Math.PI * r;
  const offset = circ - (pct / 100) * circ;
  return '<svg width="'+size+'" height="'+size+'"><circle cx="'+(size/2)+'" cy="'+(size/2)+'" r="'+r+'" fill="none" stroke="#e9edf2" stroke-width="'+stroke+'"/><circle cx="'+(size/2)+'" cy="'+(size/2)+'" r="'+r+'" fill="none" stroke="'+color+'" stroke-width="'+stroke+'" stroke-dasharray="'+circ+'" stroke-dashoffset="'+offset+'" stroke-linecap="round"/></svg>';
}

function renderKPI() {
  const projects = [...new Set(DATA.map(r => r.Project))].filter(Boolean).sort();
  let h = '';

  h += '<div class="kpi-toggle">';
  h += '<div class="kpi-toggle-btn' + (kpiView === 'project' ? ' active' : '') + '" onclick="kpiView=\'project\';renderAll()">Selected Project</div>';
  h += '<div class="kpi-toggle-btn' + (kpiView === 'portfolio' ? ' active' : '') + '" onclick="kpiView=\'portfolio\';renderAll()">Portfolio Overview</div>';
  h += '</div>';

  if (kpiView === 'portfolio') {
    // Portfolio view - all projects summary
    const allStats = getCompletionStats(null);
    let totalAll = 0, doneAll = 0;
    projects.forEach(p => { const s = getCompletionStats(p); totalAll += s.total; doneAll += s.done; });
    const pctAll = totalAll > 0 ? Math.round((doneAll / totalAll) * 100) : 0;

    h += '<div style="display:grid;grid-template-columns:auto 1fr;gap:20px;align-items:start;margin-bottom:16px;">';
    // Big ring
    h += '<div style="text-align:center;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:20px 28px;">';
    h += '<div class="kpi-big-ring">' + ringSVG(pctAll, 80, 7, pctAll >= 60 ? '#779d36' : pctAll >= 30 ? '#e8a930' : '#e05252') + '<span class="kpi-big-pct">' + pctAll + '%</span></div>';
    h += '<div class="kpi-label" style="margin-bottom:0;">Portfolio Complete</div>';
    h += '<div class="kpi-sub">' + doneAll + ' / ' + totalAll + ' items</div>';
    h += '</div>';
    // Project grid
    h += '<div class="kpi-portfolio">';
    projects.forEach(p => {
      const s = getCompletionStats(p);
      const col = barColor(s.pct);
      const fillColor = col === 'done' ? '#2ecc8a' : col === 'green' ? '#779d36' : col === 'amber' ? '#e8a930' : '#e05252';
      h += '<div class="kpi-proj-mini' + (p === selProject ? ' active' : '') + '" data-project="' + esc(p) + '" onclick="selProject=this.dataset.project;kpiView=\'project\';renderAll()">';
      h += '<div class="kpi-proj-name">' + esc(p) + '</div>';
      h += '<div class="kpi-proj-pct" style="color:' + fillColor + ';">' + s.pct + '%</div>';
      h += '<div class="kpi-proj-bar"><div class="kpi-proj-bar-fill ' + col + '" style="width:' + s.pct + '%;"></div></div>';
      h += '<div class="kpi-sub">' + s.done + '/' + s.total + '</div>';
      h += '</div>';
    });
    h += '</div></div>';

  } else {
    // Single project KPI
    const overall = getCompletionStats(selProject);
    const ringColor = overall.pct >= 60 ? '#779d36' : overall.pct >= 30 ? '#e8a930' : '#e05252';

    h += '<div class="kpi-dash">';

    // Overall progress card with ring
    h += '<div class="kpi-card kpi-overall" style="grid-row:span 2;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;min-height:160px;">';
    h += '<div class="kpi-big-ring" style="width:90px;height:90px;">' + ringSVG(overall.pct, 90, 8, ringColor) + '<span class="kpi-big-pct" style="font-size:26px;">' + overall.pct + '%</span></div>';
    h += '<div class="kpi-label" style="margin-top:8px;">Overall Completion</div>';
    h += '<div class="kpi-sub">' + overall.done + ' of ' + overall.total + ' items complete</div>';
    h += '</div>';

    // Per-category cards
    CATEGORIES.forEach(cat => {
      const s = getCompletionStats(selProject, cat);
      if (s.total === 0) return;
      const catClass = 'kpi-' + cat.toLowerCase().replace(/[^a-z]/g, '');
      const col = barColor(s.pct);
      h += '<div class="kpi-card ' + catClass + '">';
      h += '<div class="kpi-label">' + (CAT_ICONS[cat] || '') + ' ' + esc(cat) + '</div>';
      h += '<div style="display:flex;justify-content:space-between;align-items:baseline;">';
      h += '<div class="kpi-value">' + s.done + '<span style="font-size:16px;font-weight:600;color:#b0bac4;">/' + s.total + '</span></div>';
      h += '<div style="font-family:Barlow Condensed;font-size:18px;font-weight:700;color:' + (s.pct >= 100 ? '#2ecc8a' : s.pct >= 60 ? '#779d36' : s.pct >= 30 ? '#e8a930' : '#e05252') + ';">' + s.pct + '%</div>';
      h += '</div>';
      h += '<div class="kpi-bar-track"><div class="kpi-bar-fill ' + col + '" style="width:' + s.pct + '%;"></div></div>';
      h += '</div>';
    });

    h += '</div>';
  }

  return h;
}

function renderAll(projects) {
  if (!projects) projects = [...new Set(DATA.map(r => r.Project))].filter(Boolean).sort();

  let html = '';
  // Project tabs
  html += '<div class="proj-tabs" id="projTabs">';
  projects.forEach(p => {
    html += '<div class="proj-tab' + (p === selProject ? ' active' : '') + '" data-project="' + esc(p) + '" onclick="selectProject(this.dataset.project)">' + esc(p) + '</div>';
  });
  html += '</div>';

  // Toolbar
  html += '<div class="toolbar"><input class="search-box" placeholder="üîç Search topics..." oninput="doSearch(this.value)" value="' + (searchQ||'') + '"><button class="add-proj-btn" onclick="showAddProject()">+ New Project</button><button class="del-proj-btn" onclick="confirmDeleteProject()">üóë Delete Project</button><span class="sync-status" id="syncStatus"></span></div>';

  // KPI Dashboard
  html += '<div id="kpiDash">' + renderKPI() + '</div>';

  // Content
  html += '<div id="catContent">';
  html += renderCategories();
  html += '</div>';

  document.getElementById("mainContent").innerHTML = html;
  setTimeout(autoGrowAll, 0);
  renderSidebarProjects();
}

function renderCategories() {
  const items = DATA.filter(r => r.Project === selProject);
  const groups = {};
  items.forEach(r => { if (!groups[r.Category]) groups[r.Category] = []; groups[r.Category].push(r); });

  let html = "";
  CATEGORIES.forEach(cat => {
    let rows = groups[cat];
    if (!rows) return;
    rows.sort((a,b) => (a.SortOrder||0) - (b.SortOrder||0));

    if (searchQ) {
      rows = rows.filter(r => r.Topic.toLowerCase().includes(searchQ) || (r.Value||"").toLowerCase().includes(searchQ));
      if (!rows.length) return;
    }

    const catId = cat.replace(/[^a-zA-Z]/g, "");
    const isCollapsed = collapsed[cat];
    const cls = CAT_CLASSES[cat] || "cat-general";
    const icon = CAT_ICONS[cat] || "";
    const doneCount = rows.filter(r => r.Complete).length;
    const countStyle = doneCount === rows.length && rows.length > 0 ? "color:#2ecc8a;" : "";

    html += '<div class="cat-section">';
    html += '<div class="cat-header ' + cls + (isCollapsed ? ' collapsed' : '') + '" data-cat="' + esc(cat) + '" onclick="toggleCat(this.dataset.cat)"><span>' + icon + ' ' + esc(cat) + '</span><span style="display:flex;align-items:center;gap:12px;"><span style="font-size:12px;font-weight:600;' + countStyle + '">' + doneCount + '/' + rows.length + '</span><span class="cat-chevron">‚ñº</span></span></div>';
    html += '<div class="cat-body' + (isCollapsed ? ' hidden' : '') + '">';

    rows.forEach(r => {
      const val = r.Value || "";
      const emptyCls = val ? "" : " empty";
      const escaped = val.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      const key = r.Project + "|" + r.Category + "|" + r.Topic;
      const itemId = spItemMap[key] || "";
      const hasComm = comments[itemId] && comments[itemId].length > 0;

      html += '<div class="topic-row' + (r.Complete ? ' completed' : '') + '">';
      html += '<div class="topic-check"><input type="checkbox" ' + (r.Complete ? 'checked ' : '') + 'data-proj="' + esc(r.Project) + '" data-cat="' + esc(r.Category) + '" data-topic="' + esc(r.Topic) + '" onchange="toggleComplete(this.dataset.proj,this.dataset.cat,this.dataset.topic,this)"></div>';
      html += '<div style="display:flex;flex-direction:column;overflow:hidden;">';
      html += '<div class="topic-label">' + esc(r.Topic) + '</div>';
      html += '<div class="topic-val"><textarea rows="1" class="' + emptyCls + '" data-proj="' + esc(r.Project) + '" data-cat="' + esc(r.Category) + '" data-topic="' + esc(r.Topic) + '" oninput="autoGrow(this)" onblur="onEdit(this.dataset.proj,this.dataset.cat,this.dataset.topic,this)" onfocus="this.classList.remove(&quot;empty&quot;)">' + escaped + '</textarea></div>';
      html += '</div>';
      html += '<div class="comment-btn' + (hasComm ? ' has-comments' : '') + '" data-proj="' + esc(r.Project) + '" data-cat="' + esc(r.Category) + '" data-topic="' + esc(r.Topic) + '" data-itemid="' + itemId + '" onclick="openCommentPanel(this.dataset.proj,this.dataset.cat,this.dataset.topic,this.dataset.itemid)" title="Comments">üí¨</div>';
      html += '</div>';
    });

    html += '</div>';

    // Add Row button at bottom of each category (spans both columns)
    html += '<div class="add-row-area" style="grid-column:1/-1;padding:8px 16px;border-top:1px solid #f0f4f8;">';
    html += '<div class="add-row-inline" id="addRowInline_' + catId + '" style="display:none;margin-bottom:8px;">';
    html += '<div style="display:flex;gap:8px;align-items:center;">';
    html += '<input class="form-input" id="addRowInput_' + catId + '" placeholder="New topic name..." style="flex:1;padding:6px 10px;font-size:12px;" data-cat="' + esc(cat) + '" onkeydown="if(event.key===\'Enter\')doAddRow(this.dataset.cat,\'' + catId + '\')">';
    html += '<button style="padding:6px 14px;border-radius:6px;border:none;background:var(--green);color:#fff;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;" data-cat="' + esc(cat) + '" onclick="doAddRow(this.dataset.cat,\'' + catId + '\')">Add</button>';
    html += '<button style="padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;color:#8a9baa;font-size:12px;cursor:pointer;" onclick="document.getElementById(\'addRowInline_' + catId + '\').style.display=\'none\'">Cancel</button>';
    html += '</div></div>';
    html += '<div class="add-row-trigger" style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#8a9baa;font-size:12px;font-weight:600;padding:4px 0;transition:color 0.15s;" onclick="showAddRow(\'' + catId + '\')" onmouseover="this.style.color=\'var(--green)\'" onmouseout="this.style.color=\'#8a9baa\'">';
    html += '<span style="font-size:14px;">+</span> Add row to ' + esc(cat);
    html += '</div></div>';

    html += '</div>';
  });
  return html;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

function autoGrowAll() {
  document.querySelectorAll('.topic-val textarea').forEach(function(el) {
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  });
}
function selectProject(p) { selProject = p; renderAll(); }

function renderSidebarProjects() {
  var el = document.getElementById("sidebarProjects");
  if (!el) return;
  var projects = [...new Set(DATA.map(function(r){return r.Project;}))].filter(Boolean).sort();
  var html = "";
  projects.forEach(function(p) {
    var s = getCompletionStats(p);
    var col = s.pct >= 100 ? '#2ecc8a' : s.pct >= 60 ? '#779d36' : s.pct >= 30 ? '#e8a930' : '#e05252';
    html += '<div class="sidebar-proj' + (p === selProject ? ' active' : '') + '" data-project="' + esc(p) + '" onclick="selectProject(this.dataset.project)">';
    html += '<span class="dot" style="background:' + col + ';"></span>';
    html += '<span class="pname">' + esc(p) + '</span>';
    html += '<span class="ppct">' + s.pct + '%</span>';
    html += '</div>';
  });
  el.innerHTML = html;
}
function doSearch(q) { searchQ = q.toLowerCase(); document.getElementById("catContent").innerHTML = renderCategories(); setTimeout(autoGrowAll, 0); }
function toggleCat(cat) {
  collapsed[cat] = !collapsed[cat];
  document.getElementById("catContent").innerHTML = renderCategories();
  setTimeout(autoGrowAll, 0);
}

function showAddRow(catId) {
  var inline = document.getElementById("addRowInline_" + catId);
  if (inline) {
    inline.style.display = "";
    var input = document.getElementById("addRowInput_" + catId);
    if (input) input.focus();
  }
}

async function doAddRow(category, catId) {
  var input = document.getElementById("addRowInput_" + catId);
  var topicName = input ? input.value.trim() : "";
  if (!topicName || !selProject) return;

  // Check for duplicate topic in this project+category
  var exists = DATA.some(function(r) {
    return r.Project === selProject && r.Category === category && r.Topic === topicName;
  });
  if (exists) {
    showToast("Topic '" + topicName + "' already exists in " + category, "err");
    return;
  }

  // Find the max SortOrder for this project+category and add 1
  var catRows = DATA.filter(function(r) { return r.Project === selProject && r.Category === category; });
  var maxSort = 0;
  catRows.forEach(function(r) { if ((r.SortOrder || 0) > maxSort) maxSort = r.SortOrder || 0; });
  var newSort = maxSort + 1;

  var newRow = {
    Title: selProject + " \u2014 " + topicName,
    Project: selProject,
    Category: category,
    Topic: topicName,
    Value: "",
    SortOrder: newSort,
    Complete: false
  };

  // Create in SharePoint
  try {
    var resp = await graph("POST", LIST + "/items", { fields: {
      Title: newRow.Title, Project: newRow.Project, Category: newRow.Category,
      Topic: newRow.Topic, Value: "", SortOrder: newRow.SortOrder
    }});
    if (resp && resp.id) {
      spItemMap[selProject + "|" + category + "|" + topicName] = resp.id;
      newRow.id = resp.id;
    }
    DATA.push(newRow);
    renderAll();
    showToast("+ Added '" + topicName + "' to " + category, "ok");
  } catch(e) {
    console.error("Failed to add row:", e);
    showToast("Failed to add row: " + e.message, "err");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT + COMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onEdit(project, category, topic, textarea) {
  const key = project + "|" + category + "|" + topic;
  const itemId = spItemMap[key];
  const idx = DATA.findIndex(r => r.Project === project && r.Category === category && r.Topic === topic);
  if (idx >= 0) DATA[idx].Value = textarea.value;
  textarea.className = textarea.value ? "" : "empty";
  if (itemId) queueSave(itemId, "Value", textarea.value);
}

function toggleComplete(project, category, topic, checkbox) {
  const key = project + "|" + category + "|" + topic;
  const itemId = spItemMap[key];
  const idx = DATA.findIndex(r => r.Project === project && r.Category === category && r.Topic === topic);
  if (idx >= 0) DATA[idx].Complete = checkbox.checked;
  const row = checkbox.closest(".topic-row");
  if (checkbox.checked) row.classList.add("completed"); else row.classList.remove("completed");
  if (itemId) queueSave(itemId, "Complete", checkbox.checked);
  // Update counter + KPI
  document.getElementById("catContent").innerHTML = renderCategories();
  setTimeout(autoGrowAll, 0);
  var kpiEl = document.getElementById("kpiDash");
  if (kpiEl) kpiEl.innerHTML = renderKPI();
  showToast(checkbox.checked ? "‚úì Marked complete" : "‚Ü© Reopened", "ok");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMENTS + @MENTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCommentPanel(project, category, topic, itemId) {
  openComment = { project, category, topic, itemId };
  // Load comments from localStorage (or could be SP)
  if (!comments[itemId]) {
    try { comments = JSON.parse(localStorage.getItem("pmo_comments") || "{}"); } catch(e) { comments = {}; }
  }
  renderCommentPanel();
}

function closeCommentPanel() {
  openComment = null;
  document.getElementById("commentPanel").innerHTML = "";
}

function renderCommentPanel() {
  if (!openComment) return;
  const c = openComment;
  const itemComments = comments[c.itemId] || [];

  let html = '<div class="overlay" onclick="closeCommentPanel()"></div>';
  html += '<div class="comment-panel">';
  html += '<div class="comment-panel-head"><div><div class="comment-panel-title">üí¨ Comments</div><div class="comment-panel-topic">' + c.project + ' ‚Üí ' + c.topic + '</div></div><button class="comment-close" onclick="closeCommentPanel()">‚úï</button></div>';

  html += '<div class="comment-list" id="commentList">';
  if (itemComments.length === 0) {
    html += '<div style="text-align:center;padding:40px;color:#c4d0dc;font-size:13px;">No comments yet.<br>Type @ to mention someone.</div>';
  } else {
    itemComments.forEach(cm => {
      const text = cm.text.replace(/@(\w[\w\s]*?\w)/g, '<span class="mention">@$1</span>');
      html += '<div class="comment-item"><span class="comment-author">' + cm.author + '</span><span class="comment-time">' + cm.time + '</span><div class="comment-text">' + text + '</div></div>';
    });
  }
  html += '</div>';

  html += '<div class="comment-input-area"><div class="mention-dropdown" id="mentionDropdown"></div>';
  html += '<textarea class="comment-input" id="commentInput" placeholder="Add a comment... Type @ to mention someone" oninput="onCommentInput(this)" onkeydown="onCommentKeydown(event)"></textarea>';
  html += '<button class="comment-send" onclick="sendComment()">Send</button>';
  html += '</div></div>';

  document.getElementById("commentPanel").innerHTML = html;
  setTimeout(() => document.getElementById("commentInput").focus(), 100);
}

let mentionIdx = -1;
let mentionMatches = [];

function onCommentInput(textarea) {
  const val = textarea.value;
  const pos = textarea.selectionStart;
  // Find @ trigger
  const before = val.substring(0, pos);
  const atIdx = before.lastIndexOf("@");

  if (atIdx >= 0 && (atIdx === 0 || before[atIdx-1] === " " || before[atIdx-1] === "\n")) {
    const query = before.substring(atIdx + 1).toLowerCase();
    if (query.length >= 0 && !query.includes(" ") || query.split(" ").length <= 2) {
      mentionMatches = TEAM.filter(t => t.name.toLowerCase().includes(query) || t.nick.toLowerCase().includes(query)).slice(0, 6);
      if (mentionMatches.length > 0) {
        mentionIdx = 0;
        renderMentionDropdown();
        return;
      }
    }
  }
  hideMentionDropdown();
}

function onCommentKeydown(e) {
  const dd = document.getElementById("mentionDropdown");
  if (!dd.classList.contains("show")) return;

  if (e.key === "ArrowDown") { e.preventDefault(); mentionIdx = Math.min(mentionIdx + 1, mentionMatches.length - 1); renderMentionDropdown(); }
  else if (e.key === "ArrowUp") { e.preventDefault(); mentionIdx = Math.max(mentionIdx - 1, 0); renderMentionDropdown(); }
  else if (e.key === "Enter" || e.key === "Tab") {
    if (mentionMatches.length > 0) { e.preventDefault(); insertMention(mentionMatches[mentionIdx]); }
  }
  else if (e.key === "Escape") { hideMentionDropdown(); }
}

function renderMentionDropdown() {
  const dd = document.getElementById("mentionDropdown");
  dd.innerHTML = mentionMatches.map((t, i) => {
    const initials = t.name.split(" ").map(n => n[0]).join("").substring(0, 2);
    return '<div class="mention-item' + (i === mentionIdx ? ' selected' : '') + '" data-email="' + esc(t.email) + '" onclick="insertMention(TEAM.find(function(x){return x.email===this.dataset.email}.bind(this)))"><div class="mention-avatar">' + initials + '</div><div><div class="mention-name">' + esc(t.name) + '</div><div class="mention-email">' + esc(t.email) + '</div></div></div>';
  }).join("");
  dd.classList.add("show");
}

function hideMentionDropdown() {
  const dd = document.getElementById("mentionDropdown");
  if (dd) dd.classList.remove("show");
  mentionIdx = -1;
  mentionMatches = [];
}

function insertMention(person) {
  const textarea = document.getElementById("commentInput");
  const val = textarea.value;
  const pos = textarea.selectionStart;
  const before = val.substring(0, pos);
  const atIdx = before.lastIndexOf("@");
  const after = val.substring(pos);

  textarea.value = before.substring(0, atIdx) + "@" + person.name + " " + after;
  textarea.selectionStart = textarea.selectionEnd = atIdx + person.name.length + 2;
  textarea.focus();
  hideMentionDropdown();
}

async function sendComment() {
  if (!openComment) return;
  const textarea = document.getElementById("commentInput");
  const text = textarea.value.trim();
  if (!text) return;

  const c = openComment;
  const now = new Date();
  const timeStr = now.toLocaleDateString() + " " + now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  // Save comment locally
  if (!comments[c.itemId]) comments[c.itemId] = [];
  comments[c.itemId].push({ author: currentUser || "You", text, time: timeStr });
  localStorage.setItem("pmo_comments", JSON.stringify(comments));

  // Find @mentions and send Teams messages
  const mentions = text.match(/@([\w][\w\s-]*[\w])/g);
  if (mentions) {
    for (const m of mentions) {
      const name = m.substring(1).trim();
      const person = TEAM.find(t => t.name.toLowerCase() === name.toLowerCase());
      if (person) {
        sendTeamsMessage(person, c, text);
      }
    }
  }

  renderCommentPanel();
  // Scroll to bottom
  const list = document.getElementById("commentList");
  if (list) list.scrollTop = list.scrollHeight;

  // Update comment icon
  document.getElementById("catContent").innerHTML = renderCategories();
  setTimeout(autoGrowAll, 0);
}

async function sendTeamsMessage(person, context, commentText) {
  try {
    // Get the user's ID from their email
    const user = await graph("GET", "/users/" + encodeURIComponent(person.email));
    const userId = user.id;

    // Get current user ID
    const me = await graph("GET", "/me");

    // Create 1:1 chat
    const chat = await graph("POST", "/chats", {
      chatType: "oneOnOne",
      members: [
        { "@odata.type": "#microsoft.graph.aadUserConversationMember", roles: ["owner"], "user@odata.bind": "https://graph.microsoft.com/v1.0/users('" + me.id + "')" },
        { "@odata.type": "#microsoft.graph.aadUserConversationMember", roles: ["owner"], "user@odata.bind": "https://graph.microsoft.com/v1.0/users('" + userId + "')" }
      ]
    });

    // Send message
    const msgBody = "üìã <b>PMO Update ‚Äî " + context.project + "</b><br>" +
      "<b>" + context.topic + "</b> (" + context.category + ")<br><br>" +
      commentText.replace(/@([\w][\w\s-]*[\w])/g, '<b>@$1</b>') +
      "<br><br><i>‚Äî " + (currentUser || "PMO Dashboard") + "</i>";

    await graph("POST", "/chats/" + chat.id + "/messages", {
      body: { contentType: "html", content: msgBody }
    });

    showToast("üí¨ Teams message sent to " + person.name, "ok");
  } catch (e) {
    console.error("Teams msg failed:", e);
    showToast("Teams notification failed: " + e.message, "err");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, type) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "toast show " + (type || "ok");
  setTimeout(() => t.classList.remove("show"), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW PROJECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _newVars = [];

// Hardcoded project template ‚Äî 87 standard topics across 7 categories
const PROJECT_TEMPLATE = [
  // General (8)
  {cat:"General",topic:"Contract",sort:1},
  {cat:"General",topic:"Contract Action Item List",sort:2},
  {cat:"General",topic:"Contract Flow Down Provisions",sort:3},
  {cat:"General",topic:"Insurance - through GC Pay",sort:4},
  {cat:"General",topic:"Bond",sort:5},
  {cat:"General",topic:"DEI",sort:6},
  {cat:"General",topic:"Subcontractor",sort:7},
  {cat:"General",topic:"NTP/LNTP",sort:8},
  // Permitting (5)
  {cat:"Permitting",topic:"Building Permit",sort:9},
  {cat:"Permitting",topic:"Electrical Permit",sort:10},
  {cat:"Permitting",topic:"SWPPP/ENOI",sort:11},
  {cat:"Permitting",topic:"Fire Permit",sort:12},
  {cat:"Permitting",topic:"Driveway Permit",sort:13},
  // Engineering (24)
  {cat:"Engineering",topic:"Civil IFCs",sort:14},
  {cat:"Engineering",topic:"Site topo done and confirmed included in design?",sort:15},
  {cat:"Engineering",topic:"Site topo done if array grading was involved?",sort:16},
  {cat:"Engineering",topic:"Electrical IFCs",sort:17},
  {cat:"Engineering",topic:"Racking IFCs",sort:18},
  {cat:"Engineering",topic:"Structural IFCs",sort:19},
  {cat:"Engineering",topic:"DAS",sort:20},
  {cat:"Engineering",topic:"IE/Client Approved?",sort:21},
  {cat:"Engineering",topic:"Procurement (Equipment/Materials)",sort:22},
  {cat:"Engineering",topic:"Modules",sort:23},
  {cat:"Engineering",topic:"Racking",sort:24},
  {cat:"Engineering",topic:"Yellow Jackets,if required?",sort:25},
  {cat:"Engineering",topic:"Inverters",sort:26},
  {cat:"Engineering",topic:"Combiner Boxes",sort:27},
  {cat:"Engineering",topic:"Switchboards",sort:28},
  {cat:"Engineering",topic:"MV XFMR",sort:29},
  {cat:"Engineering",topic:"GXFMR",sort:30},
  {cat:"Engineering",topic:"Aux Panelboard/XFMR",sort:31},
  {cat:"Engineering",topic:"GOAB",sort:32},
  {cat:"Engineering",topic:"Recloser",sort:33},
  {cat:"Engineering",topic:"Metering Cluster/Meter",sort:34},
  {cat:"Engineering",topic:"ESS",sort:36},
  {cat:"Engineering",topic:"DC/DC Converters",sort:37},
  {cat:"Engineering",topic:"Controller/EMS",sort:38},
  // Procurement (Subcontractors) (8)
  {cat:"Procurement (Subcontractors)",topic:"Survey",sort:39},
  {cat:"Procurement (Subcontractors)",topic:"Civil Work",sort:40},
  {cat:"Procurement (Subcontractors)",topic:"Post Install",sort:41},
  {cat:"Procurement (Subcontractors)",topic:"Rack & Module Install",sort:42},
  {cat:"Procurement (Subcontractors)",topic:"LV Electrical Work + DAS",sort:43},
  {cat:"Procurement (Subcontractors)",topic:"MV ElectricalWork",sort:44},
  {cat:"Procurement (Subcontractors)",topic:"Fence",sort:45},
  {cat:"Procurement (Subcontractors)",topic:"Landscaping/Seeding, if different",sort:46},
  // Construction (31)
  {cat:"Construction",topic:"Safety/HASP",sort:47},
  {cat:"Construction",topic:"QA/QC Workbook",sort:48},
  {cat:"Construction",topic:"Premob checklist",sort:49},
  {cat:"Construction",topic:"Page Turn",sort:50},
  {cat:"Construction",topic:"Pre-Con Meeting with Town",sort:51},
  {cat:"Construction",topic:"Mobilization ready",sort:52},
  {cat:"Construction",topic:"AI Clearing",sort:53},
  {cat:"Construction",topic:"SWPPP Inspection",sort:54},
  {cat:"Construction",topic:"AHJ inspection",sort:55},
  {cat:"Construction",topic:"Soil Test",sort:56},
  {cat:"Construction",topic:"Seeding Status",sort:57},
  {cat:"Construction",topic:"Interconnection Status",sort:58},
  {cat:"Construction",topic:"Close-Out Set-Up?",sort:59},
  {cat:"Construction",topic:"Schedule",sort:60},
  {cat:"Construction",topic:"Mobilization",sort:61},
  {cat:"Construction",topic:"Civil Work Start",sort:62},
  {cat:"Construction",topic:"Civil Work Finish",sort:63},
  {cat:"Construction",topic:"Trenching + Pads Start",sort:64},
  {cat:"Construction",topic:"Trenching + Pads Finish",sort:65},
  {cat:"Construction",topic:"Post Install Start",sort:66},
  {cat:"Construction",topic:"Post Install Finish",sort:67},
  {cat:"Construction",topic:"Rack Install Start",sort:68},
  {cat:"Construction",topic:"Rack Install Finish",sort:69},
  {cat:"Construction",topic:"Module Install Start",sort:70},
  {cat:"Construction",topic:"Module Install Finish",sort:71},
  {cat:"Construction",topic:"DC Work Start",sort:72},
  {cat:"Construction",topic:"DC Work Finish",sort:73},
  {cat:"Construction",topic:"AC Work Start",sort:74},
  {cat:"Construction",topic:"AC Work Finish",sort:75},
  {cat:"Construction",topic:"MV Work Start",sort:76},
  {cat:"Construction",topic:"MV Work Finish",sort:77},
  // Milestones (6)
  {cat:"Milestones",topic:"NTP/Mob",sort:78},
  {cat:"Milestones",topic:"MC",sort:79},
  {cat:"Milestones",topic:"WT",sort:80},
  {cat:"Milestones",topic:"PTO",sort:81},
  {cat:"Milestones",topic:"SC",sort:82},
  {cat:"Milestones",topic:"FC",sort:83},
  // Finance (4)
  {cat:"Finance",topic:"IRA/Dom Content Set-up & Progress?",sort:84},
  {cat:"Finance",topic:"Buyout sheet",sort:85},
  {cat:"Finance",topic:"Contract Change Orders?",sort:86},
  {cat:"Finance",topic:"Current/Upcoming Invoice Status",sort:87}
];

function showAddProject() {
  const modal = document.getElementById("addProjectModal");
  modal.style.display = "";
  modal.innerHTML = '<div class="modal-overlay" onclick="if(event.target===this)closeAddProject()">' +
    '<div class="modal">' +
    '<div class="modal-head"><div class="modal-title">+ New Project</div><button class="modal-close" onclick="closeAddProject()">\u2715</button></div>' +
    '<div class="modal-body">' +
    '<div class="form-group"><label class="form-label">Project Name *</label><input class="form-input" id="newProjName" placeholder="e.g. Discovery Way" oninput="validateNewProj()"></div>' +
    '<div class="form-group"><label class="form-label">Client</label><input class="form-input" id="newProjClient" placeholder="e.g. NextEra, Bluewave"></div>' +
    '<div class="form-group"><label class="form-label">State</label><input class="form-input" id="newProjState" placeholder="e.g. NY, MA, PA"></div>' +
    '<div class="form-group"><label class="form-label">Custom Variables</label>' +
    '<div class="form-hint">Add project-specific fields that appear at the top of the project view</div>' +
    '<div id="varList" class="var-list"></div>' +
    '<div class="var-add-row"><input class="var-add-input" id="varName" placeholder="Variable name..." onkeydown="if(event.key===\'Enter\')addVar()"><input class="var-add-input" id="varValue" placeholder="Value..." onkeydown="if(event.key===\'Enter\')addVar()"><button class="var-add-btn" onclick="addVar()">+ Add</button></div>' +
    '</div></div>' +
    '<div class="modal-footer"><button class="btn-cancel" onclick="closeAddProject()">Cancel</button><button class="btn-create" id="btnCreateProj" onclick="createProject()" disabled>\u26A1 Create Project</button></div>' +
    '</div></div>';
  _newVars = [];
  renderVarList();
  document.getElementById("newProjName").focus();
}

function closeAddProject() { document.getElementById("addProjectModal").style.display = "none"; }

function validateNewProj() {
  var name = document.getElementById("newProjName").value.trim();
  var existing = [...new Set(DATA.map(function(r){return r.Project;}))];
  document.getElementById("btnCreateProj").disabled = !name || existing.indexOf(name) >= 0;
}

function addVar() {
  var n = document.getElementById("varName").value.trim();
  var v = document.getElementById("varValue").value.trim();
  if (!n) return;
  _newVars.push({name:n,value:v});
  document.getElementById("varName").value = "";
  document.getElementById("varValue").value = "";
  document.getElementById("varName").focus();
  renderVarList();
}

function removeVar(idx) { _newVars.splice(idx,1); renderVarList(); }

function renderVarList() {
  var el = document.getElementById("varList");
  if (!el) return;
  if (_newVars.length === 0) { el.innerHTML = '<span style="font-size:12px;color:#c4d0dc;">No custom variables yet</span>'; return; }
  el.innerHTML = _newVars.map(function(v,i) {
    return '<span class="var-tag">' + esc(v.name) + (v.value ? ': ' + esc(v.value) : '') + '<span class="x" onclick="removeVar('+i+')">\u00d7</span></span>';
  }).join("");
}

async function createProject() {
  var name = document.getElementById("newProjName").value.trim();
  var client = document.getElementById("newProjClient").value.trim();
  var state = document.getElementById("newProjState").value.trim();
  if (!name) return;

  var templateRows = PROJECT_TEMPLATE;

  // Disable button and show progress
  var btn = document.getElementById("btnCreateProj");
  btn.disabled = true;
  btn.textContent = "Creating... 0/" + templateRows.length;

  // Create rows in SharePoint
  var created = 0;
  var failed = 0;
  for (var i = 0; i < templateRows.length; i++) {
    var ref = templateRows[i];
    var newRow = {
      Title: name + " \u2014 " + ref.topic,
      Project: name,
      Category: ref.cat,
      Topic: ref.topic,
      Value: "",
      SortOrder: ref.sort,
      Complete: false
    };
    try {
      var resp = await graph("POST", LIST + "/items", { fields: {
        Title: newRow.Title, Project: newRow.Project, Category: newRow.Category,
        Topic: newRow.Topic, Value: "", SortOrder: newRow.SortOrder
      }});
      if (resp && resp.id) {
        spItemMap[name + "|" + ref.cat + "|" + ref.topic] = resp.id;
        newRow.id = resp.id;
      }
      DATA.push(newRow);
      created++;
    } catch(e) {
      console.error("Failed to create item " + ref.cat + "/" + ref.topic + ":", e);
      failed++;
    }
    btn.textContent = "Creating... " + (i + 1) + "/" + templateRows.length;
  }

  closeAddProject();
  selProject = name;
  renderAll();
  var msg = "\u26A1 " + name + " created with " + created + " items";
  if (failed > 0) msg += " (" + failed + " failed)";
  showToast(msg, failed > 0 ? "info" : "ok");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE PROJECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmDeleteProject() {
  if (!selProject) return;
  var projRows = DATA.filter(function(r){return r.Project === selProject;});
  var modal = document.getElementById("addProjectModal");
  modal.style.display = "";
  modal.innerHTML = '<div class="modal-overlay" onclick="if(event.target===this)closeAddProject()">' +
    '<div class="modal">' +
    '<div class="modal-head"><div class="modal-title" style="color:var(--red);">‚ö†Ô∏è Delete Project</div><button class="modal-close" onclick="closeAddProject()">\u2715</button></div>' +
    '<div class="modal-body">' +
    '<p style="font-size:14px;color:#4a5568;margin-bottom:16px;">Are you sure you want to permanently delete <strong>' + esc(selProject) + '</strong>?</p>' +
    '<p style="font-size:13px;color:#8a9baa;margin-bottom:16px;">This will remove all <strong>' + projRows.length + ' items</strong> from SharePoint. This cannot be undone.</p>' +
    '<div style="padding:12px 16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin-bottom:16px;">' +
    '<label style="font-size:12px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:0.5px;">Type project name to confirm</label>' +
    '<input class="form-input" id="deleteConfirmInput" placeholder="' + esc(selProject) + '" oninput="validateDeleteConfirm()" style="margin-top:6px;border-color:#fecaca;">' +
    '</div>' +
    '</div>' +
    '<div class="modal-footer"><button class="btn-cancel" onclick="closeAddProject()">Cancel</button><button class="btn-delete" id="btnDeleteProj" onclick="executeDeleteProject()" disabled>üóë Delete ' + esc(selProject) + '</button></div>' +
    '</div></div>';
  document.getElementById("deleteConfirmInput").focus();
}

function validateDeleteConfirm() {
  var input = document.getElementById("deleteConfirmInput").value.trim();
  document.getElementById("btnDeleteProj").disabled = input !== selProject;
}

async function executeDeleteProject() {
  var projectName = selProject;
  if (!projectName) return;

  var btn = document.getElementById("btnDeleteProj");
  btn.disabled = true;

  // Find all SharePoint item IDs for this project
  var projRows = DATA.filter(function(r){return r.Project === projectName;});
  var itemIds = [];
  projRows.forEach(function(r) {
    var key = r.Project + "|" + r.Category + "|" + r.Topic;
    var spId = spItemMap[key] || r.id;
    if (spId) itemIds.push(spId);
  });

  // Deduplicate IDs
  itemIds = [...new Set(itemIds)];

  var deleted = 0;
  var failed = 0;
  btn.textContent = "Deleting... 0/" + itemIds.length;

  for (var i = 0; i < itemIds.length; i++) {
    try {
      await graph("DELETE", LIST + "/items/" + itemIds[i]);
      deleted++;
    } catch(e) {
      console.error("Failed to delete item " + itemIds[i] + ":", e);
      failed++;
    }
    btn.textContent = "Deleting... " + (i + 1) + "/" + itemIds.length;
  }

  // Remove from local DATA and spItemMap
  DATA = DATA.filter(function(r){return r.Project !== projectName;});
  Object.keys(spItemMap).forEach(function(key) {
    if (key.startsWith(projectName + "|")) delete spItemMap[key];
  });

  // Also clean up localStorage comments for this project
  try {
    var allComments = JSON.parse(localStorage.getItem("pmo_comments") || "{}");
    var cleaned = false;
    Object.keys(allComments).forEach(function(itemId) {
      if (itemIds.indexOf(itemId) >= 0 || itemIds.indexOf(Number(itemId)) >= 0) {
        delete allComments[itemId];
        cleaned = true;
      }
    });
    if (cleaned) localStorage.setItem("pmo_comments", JSON.stringify(allComments));
  } catch(e) {}

  closeAddProject();

  // Switch to first remaining project
  var remaining = [...new Set(DATA.map(function(r){return r.Project;}))].filter(Boolean).sort();
  selProject = remaining.length > 0 ? remaining[0] : null;
  renderAll();

  var msg = "üóë " + projectName + " deleted ‚Äî " + deleted + " items removed";
  if (failed > 0) msg += " (" + failed + " failed)";
  showToast(msg, failed > 0 ? "info" : "ok");
}

// Init
initAuth();
</script>
</body>
</html>
