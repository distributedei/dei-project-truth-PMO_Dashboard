<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEI PMO Report â€” Live</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style>
  :root{--navy:#375673;--green:#779d36;--amber:#e8a930;--red:#e05252;--bg:#f5f7fa;}
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Barlow',sans-serif;background:var(--bg);color:#1a1a1a;}

  /* Top bar */
  .topbar{background:linear-gradient(135deg,#375673,#2d4a63);color:#fff;padding:16px 32px;display:flex;justify-content:space-between;align-items:center;}
  .topbar h1{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;} .topbar h1 span{color:#a8c76a;}
  .topbar-right{display:flex;gap:10px;align-items:center;}
  .topbar-sub{color:rgba(255,255,255,0.5);font-size:12px;}
  .user-badge{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);}
  .btn-login{padding:8px 16px;border-radius:8px;border:none;background:#0078d4;color:#fff;font-family:'Barlow',sans-serif;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;}
  .btn-login:hover{background:#106ebe;}
  .container{max-width:1400px;margin:0 auto;padding:20px;}
  .loading{text-align:center;padding:60px;color:#8a9baa;font-size:14px;}
  .loading .spinner{display:inline-block;width:24px;height:24px;border:3px solid #e2e8f0;border-top-color:var(--green);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px;}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Project Tabs */
  .proj-tabs{display:flex;gap:6px;overflow-x:auto;padding:16px 0;border-bottom:1px solid #e2e8f0;margin-bottom:20px;}
  .proj-tab{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;border:1px solid #e2e8f0;background:#fff;color:#4a5568;transition:all 0.15s;}
  .proj-tab:hover{border-color:var(--green);color:var(--green);}
  .proj-tab.active{background:var(--green);color:#fff;border-color:var(--green);}

  /* Search + Add */
  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap;}
  .search-box{padding:8px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;width:280px;font-family:'Barlow',sans-serif;background:#fff;}
  .search-box:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 2px rgba(119,157,54,0.1);}
  .add-proj-btn{padding:8px 18px;border-radius:8px;border:none;background:linear-gradient(135deg,#779d36,#5f8228);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;}
  .add-proj-btn:hover{filter:brightness(1.1);}
  .sync-status{font-size:11px;color:#8a9baa;margin-left:auto;}
  .sync-status.syncing{color:var(--amber);}
  .sync-status.error{color:var(--red);}

  /* Category sections */
  .cat-section{margin-bottom:16px;background:#fff;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;}
  .cat-header{padding:12px 20px;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none;}
  .cat-header:hover{opacity:0.9;}
  .cat-chevron{font-size:12px;transition:transform 0.2s;color:rgba(255,255,255,0.7);}
  .cat-header.collapsed .cat-chevron{transform:rotate(-90deg);}
  .cat-body{border-top:1px solid rgba(0,0,0,0.05);}
  .cat-body.hidden{display:none;}

  /* Topic rows */
  .topic-row{display:grid;grid-template-columns:44px 220px 1fr 40px;border-bottom:1px solid #f0f4f8;min-height:40px;}
  .topic-row:last-child{border-bottom:none;}
  .topic-label{padding:10px 16px;font-size:13px;font-weight:600;color:var(--navy);background:#fafbfc;border-right:1px solid #f0f4f8;display:flex;align-items:center;}
  .topic-val{padding:8px 12px;font-size:13px;color:#4a5568;display:flex;align-items:center;position:relative;}
  .topic-check{display:flex;align-items:center;justify-content:center;padding:10px 8px;border-right:1px solid #f0f4f8;background:#fafbfc;cursor:pointer;}
  .topic-check input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--green);margin:0;}
  .topic-row.completed .topic-label{color:#8a9baa;text-decoration:line-through;text-decoration-color:#c4d0dc;}
  .topic-row.completed .topic-val textarea{color:#b0bac4;}
  .topic-val textarea{width:100%;border:1px solid transparent;background:transparent;font-family:'Barlow',sans-serif;font-size:13px;color:#4a5568;resize:vertical;min-height:28px;padding:4px 8px;border-radius:4px;line-height:1.4;transition:all 0.15s;}
  .topic-val textarea:hover{border-color:#e2e8f0;background:#fff;}
  .topic-val textarea:focus{border-color:var(--green);background:#fff;outline:none;box-shadow:0 0 0 2px rgba(119,157,54,0.15);}
  .topic-val textarea.empty{color:#c4d0dc;font-style:italic;}

  /* Comment button */
  .comment-btn{display:flex;align-items:center;justify-content:center;cursor:pointer;color:#c4d0dc;border-right:1px solid #f0f4f8;background:#fafbfc;transition:color 0.15s;padding:0 8px;}
  .comment-btn:hover{color:var(--navy);}
  .comment-btn.has-comments{color:var(--green);}

  /* Comment panel */
  .comment-panel{position:fixed;right:0;top:0;width:380px;height:100vh;background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,0.1);z-index:300;display:flex;flex-direction:column;animation:slideIn 0.2s ease-out;}
  @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
  .comment-panel-head{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;}
  .comment-panel-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:var(--navy);}
  .comment-panel-topic{font-size:12px;color:#8a9baa;margin-top:2px;}
  .comment-close{background:none;border:none;font-size:20px;cursor:pointer;color:#8a9baa;padding:4px 8px;border-radius:4px;}.comment-close:hover{background:#f0f4f8;}
  .comment-list{flex:1;overflow-y:auto;padding:16px 20px;}
  .comment-item{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #f0f4f8;}
  .comment-item:last-child{border-bottom:none;}
  .comment-author{font-size:12px;font-weight:700;color:var(--navy);}
  .comment-time{font-size:10px;color:#b0bac4;margin-left:8px;}
  .comment-text{font-size:13px;color:#4a5568;margin-top:4px;line-height:1.5;}
  .comment-text .mention{color:var(--green);font-weight:600;}
  .comment-input-area{padding:16px 20px;border-top:1px solid #e2e8f0;position:relative;}
  .comment-input{width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-family:'Barlow',sans-serif;font-size:13px;resize:none;min-height:60px;line-height:1.4;}
  .comment-input:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 2px rgba(119,157,54,0.15);}
  .comment-send{margin-top:8px;padding:8px 16px;border-radius:6px;border:none;background:var(--green);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;cursor:pointer;float:right;}
  .comment-send:hover{filter:brightness(1.1);}
  .comment-send:disabled{opacity:0.5;cursor:not-allowed;}

  /* Mention autocomplete */
  .mention-dropdown{position:absolute;bottom:100%;left:20px;right:20px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 -4px 16px rgba(0,0,0,0.08);max-height:200px;overflow-y:auto;display:none;z-index:10;}
  .mention-dropdown.show{display:block;}
  .mention-item{padding:8px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;transition:background 0.1s;}
  .mention-item:hover,.mention-item.selected{background:rgba(119,157,54,0.08);}
  .mention-avatar{width:28px;height:28px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;}
  .mention-name{font-weight:600;color:var(--navy);}
  .mention-email{font-size:11px;color:#8a9baa;}

  /* Category colors */
  .cat-general{background:linear-gradient(135deg,#375673,#2d4a63);color:#fff;}
  .cat-permitting{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;}
  .cat-engineering{background:linear-gradient(135deg,#779d36,#5f8228);color:#fff;}
  .cat-procurement{background:linear-gradient(135deg,#e8a930,#d49a20);color:#fff;}
  .cat-construction{background:linear-gradient(135deg,#e05252,#c0392b);color:#fff;}
  .cat-milestones{background:linear-gradient(135deg,#2ecc8a,#27ae60);color:#fff;}
  .cat-finance{background:linear-gradient(135deg,#0078d4,#0060aa);color:#fff;}

  .toast{position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:8px;font-weight:600;font-size:13px;opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:400;box-shadow:0 4px 12px rgba(0,0,0,0.15);color:#fff;}
  .toast.show{opacity:1;}
  .toast.ok{background:var(--green);}
  .toast.err{background:var(--red);}
  .toast.info{background:var(--navy);}

  .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:290;}
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>PMO <span>Report</span> <span style="font-size:12px;font-weight:400;color:rgba(255,255,255,0.4);vertical-align:middle;">LIVE</span></h1>
    <div class="topbar-sub">Connected to SharePoint Â· Real-time read/write</div>
  </div>
  <div class="topbar-right">
    <span class="user-badge" id="userBadge" style="display:none;"></span>
    <button class="btn-login" id="btnLogin" onclick="doLogin()">
      <svg width="16" height="16" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#F25022"/><rect x="11" y="1" width="9" height="9" fill="#7FBA00"/><rect x="1" y="11" width="9" height="9" fill="#00A4EF"/><rect x="11" y="11" width="9" height="9" fill="#FFB900"/></svg>
      Sign In
    </button>
  </div>
</div>

<div class="container">
  <div id="mainContent">
    <div class="loading"><div class="spinner"></div><br>Sign in to load PMO data from SharePoint</div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="commentPanel"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  clientId: "613928f8-0497-47ea-bb0f-c1725a1f156a",
  tenantId: "ec357a32-5b85-438d-a765-ae33c8eb13b7",
  siteId: "8103997e-0688-4832-a5b4-bf18de7f96f5",
  listId: "c0443281-dca9-49e0-856f-2748d4681399"
};
const SITE = "/sites/" + CONFIG.siteId;
const LIST = SITE + "/lists/" + CONFIG.listId;
const SCOPES = ["Sites.Manage.All", "Sites.Selected", "User.Read", "Chat.Create", "Chat.ReadWrite", "User.ReadBasic.All"];
const REDIRECT = window.location.origin + window.location.pathname;

const TEAM = [{"name": "Joshua Dean", "email": "jdean@distributedei.com", "nick": "Joshua"}, {"name": "Tom Guinta", "email": "tguinta@distributedei.com", "nick": "Tom"}, {"name": "Beth Harrington", "email": "bharrington@distributedei.com", "nick": "Beth"}, {"name": "Steve Maslen", "email": "smaslen@distributedei.com", "nick": "Steve"}, {"name": "David Moulton", "email": "dmoulton@distributedei.com", "nick": "David M"}, {"name": "Jessica Morse", "email": "jmorse@distributedei.com", "nick": "Jessica"}, {"name": "Daniel Spaizman", "email": "dspaizman@distributedei.com", "nick": "Daniel"}, {"name": "Jonas Bukh", "email": "jbukh@distributedei.com", "nick": "Jonas"}, {"name": "John Daly", "email": "jdaly@distributedei.com", "nick": "John"}, {"name": "Brian Follo", "email": "bfollo@distributedei.com", "nick": "Brian F"}, {"name": "Eli Cayer", "email": "ecayer@distributedei.com", "nick": "Eli"}, {"name": "Jackson Elwell", "email": "jelwell@distributedei.com", "nick": "Jackson"}, {"name": "Corinne Scanlon", "email": "cscanlon@distributedei.com", "nick": "Corinne"}, {"name": "Joshua Kuntz", "email": "jkuntz@distributedei.com", "nick": "Josh K"}, {"name": "Mike Wilkinson", "email": "mwilkinson@distributedei.com", "nick": "Mike W"}, {"name": "Matthew Sowle", "email": "msowle@distributedei.com", "nick": "Matt"}, {"name": "Caleb Schott", "email": "cschott@distributedei.com", "nick": "Caleb"}, {"name": "Stowe Duston", "email": "sduston@distributedei.com", "nick": "Stowe"}, {"name": "Thomas Hewitt", "email": "thewitt@distributedei.com", "nick": "Thomas"}, {"name": "Chris Shepard", "email": "cshepard@distributedei.com", "nick": "Chris"}, {"name": "Dipti Kothari", "email": "dkothari@distributedei.com", "nick": "Dipti"}, {"name": "Rusfid Haroon", "email": "rharoon@distributedei.com", "nick": "Rusfid"}, {"name": "Gabriel Murray", "email": "gmurray@distributedei.com", "nick": "Gabe"}, {"name": "David Caparelli", "email": "dcaparelli@distributeder.com", "nick": "David C"}, {"name": "Prateek Tare", "email": "ptare@distributeder.com", "nick": "Prateek"}, {"name": "Sean Harrington", "email": "sharrington@distributeder.com", "nick": "Sean"}, {"name": "Adam Regen", "email": "aregen@distributeder.com", "nick": "Adam"}, {"name": "Laura Gilman-Boutot", "email": "lgilman-boutot@distributeder.com", "nick": "Laura"}, {"name": "Trevor Maclachlan", "email": "tmaclachlan@distributeder.com", "nick": "Trevor"}, {"name": "Ryan Harrington", "email": "rharrington@distributeder.com", "nick": "Ryan"}, {"name": "Brian Parker", "email": "bparker@distributeder.com", "nick": "Brian P"}, {"name": "Joot Wright", "email": "jwright@distributeder.com", "nick": "Joot"}, {"name": "Alyssa DeBell", "email": "adebell@distributeder.com", "nick": "Alyssa"}, {"name": "David Sieczarski", "email": "dsieczarski@distributeder.com", "nick": "David S"}, {"name": "Carlton Tobler", "email": "ctobler@distributeder.com", "nick": "Carlton"}, {"name": "Peter Stanford", "email": "pstanford@distributeder.com", "nick": "Peter"}, {"name": "Alan Derosier", "email": "aderosier@distributeder.com", "nick": "Alan"}, {"name": "Ian Maclachlan", "email": "imaclachlan@distributeder.com", "nick": "Ian"}, {"name": "Julian Diaz", "email": "jdiaz@distributeder.com", "nick": "Julian"}];

const CATEGORIES = ["General", "Permitting", "Engineering", "Procurement (Subcontractors)", "Construction", "Milestones", "Finance"];
const CAT_CLASSES = {"General":"cat-general","Permitting":"cat-permitting","Engineering":"cat-engineering","Procurement (Subcontractors)":"cat-procurement","Construction":"cat-construction","Milestones":"cat-milestones","Finance":"cat-finance"};
const CAT_ICONS = {"General":"ğŸ“‹","Permitting":"ğŸ›","Engineering":"âš™ï¸","Procurement (Subcontractors)":"ğŸ”¨","Construction":"ğŸ—ï¸","Milestones":"ğŸ¯","Finance":"ğŸ’°"};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const msalInstance = new msal.PublicClientApplication({
  auth: { clientId: CONFIG.clientId, authority: "https://login.microsoftonline.com/" + CONFIG.tenantId, redirectUri: REDIRECT, navigateToLoginRequestUrl: true },
  cache: { cacheLocation: "sessionStorage" }
});

let account = null;
let DATA = [];
let spItemMap = {}; // key -> SP item id
let selProject = null;
let searchQ = "";
let collapsed = {};
let openComment = null; // {project, category, topic, itemId}
let comments = {}; // itemId -> [{author, text, time}]
let saveTimers = {};
let currentUser = null;

async function initAuth() {
  try {
    await msalInstance.initialize();
    const resp = await msalInstance.handleRedirectPromise();
    if (resp) { account = resp.account; }
    else {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length) account = accounts[0];
    }
    if (account) {
      currentUser = account.name;
      document.getElementById("userBadge").textContent = account.name;
      document.getElementById("userBadge").style.display = "";
      document.getElementById("btnLogin").style.display = "none";
      loadFromSharePoint();
    }
  } catch (e) { console.error("Init:", e); }
}

async function doLogin() {
  try { await msalInstance.loginRedirect({ scopes: SCOPES }); } catch (e) { showToast("Login failed: " + e.message, "err"); }
}

async function getToken() {
  try { return (await msalInstance.acquireTokenSilent({ scopes: SCOPES, account })).accessToken; }
  catch (e) { await msalInstance.acquireTokenRedirect({ scopes: SCOPES }); }
}

async function graph(method, path, body) {
  const token = await getToken();
  const opts = { method: method || "GET", headers: { Authorization: "Bearer " + token } };
  if (body) { opts.headers["Content-Type"] = "application/json"; opts.body = JSON.stringify(body); }
  const r = await fetch("https://graph.microsoft.com/v1.0" + path, opts);
  if (!r.ok) {
    let msg = "HTTP " + r.status;
    try { const e = await r.json(); msg = e.error?.message || msg; } catch(x) {}
    throw new Error(msg);
  }
  return r.status === 204 ? null : r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DATA FROM SHAREPOINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFromSharePoint() {
  document.getElementById("mainContent").innerHTML = '<div class="loading"><div class="spinner"></div><br>Loading PMO data from SharePoint...</div>';
  DATA = [];
  spItemMap = {};

  try {
    // Ensure Complete column exists
    try {
      await graph("POST", LIST + "/columns", { name: "Complete", displayName: "Complete", boolean: {} });
      console.log("Complete column created");
    } catch(e) { console.log("Complete column exists or error:", e.message); }

    let url = LIST + "/items?$expand=fields&$top=999";
    let page = 0;
    while (url) {
      const resp = await graph("GET", url);
      if (resp.value) {
        resp.value.forEach(item => {
          const f = item.fields;
          const row = {
            id: item.id,
            Project: f.Project || "",
            Category: f.Category || "",
            Topic: f.Topic || "",
            Value: f.Value || "",
            SortOrder: f.SortOrder || 0,
            Complete: f.Complete === true || f.Complete === "true"
          };
          DATA.push(row);
          spItemMap[row.Project + "|" + row.Category + "|" + row.Topic] = item.id;
        });
      }
      url = resp["@odata.nextLink"] ? resp["@odata.nextLink"].replace("https://graph.microsoft.com/v1.0", "") : null;
      page++;
    }

    // Determine projects from data
    const projects = [...new Set(DATA.map(r => r.Project))].filter(Boolean).sort();
    selProject = projects[0];
    showToast("Loaded " + DATA.length + " items from SharePoint", "ok");
    renderAll(projects);
  } catch (e) {
    document.getElementById("mainContent").innerHTML = '<div class="loading" style="color:var(--red);">Failed to load: ' + e.message + '</div>';
    showToast("Load failed: " + e.message, "err");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE TO SHAREPOINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function queueSave(itemId, field, value) {
  const key = itemId + "_" + field;
  clearTimeout(saveTimers[key]);
  saveTimers[key] = setTimeout(() => doSave(itemId, field, value), 800);
  setSyncStatus("syncing");
}

async function doSave(itemId, field, value) {
  try {
    const body = {};
    body[field] = value;
    await graph("PATCH", LIST + "/items/" + itemId + "/fields", body);
    setSyncStatus("saved");
  } catch (e) {
    setSyncStatus("error", e.message);
  }
}

function setSyncStatus(state, msg) {
  const el = document.getElementById("syncStatus");
  if (!el) return;
  if (state === "syncing") { el.textContent = "âŸ³ Saving..."; el.className = "sync-status syncing"; }
  else if (state === "saved") { el.textContent = "âœ“ Saved to SharePoint"; el.className = "sync-status"; setTimeout(() => { if (el.textContent.includes("Saved")) el.textContent = ""; }, 2000); }
  else if (state === "error") { el.textContent = "âœ— Save failed: " + (msg || ""); el.className = "sync-status error"; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(projects) {
  if (!projects) projects = [...new Set(DATA.map(r => r.Project))].filter(Boolean).sort();

  let html = '';
  // Project tabs
  html += '<div class="proj-tabs" id="projTabs">';
  projects.forEach(p => {
    html += '<div class="proj-tab' + (p === selProject ? ' active' : '') + '" data-project="' + esc(p) + '" onclick="selectProject(this.dataset.project)">' + esc(p) + '</div>';
  });
  html += '</div>';

  // Toolbar
  html += '<div class="toolbar"><input class="search-box" placeholder="ğŸ” Search topics..." oninput="doSearch(this.value)" value="' + (searchQ||'') + '"><span class="sync-status" id="syncStatus"></span></div>';

  // Content
  html += '<div id="catContent">';
  html += renderCategories();
  html += '</div>';

  document.getElementById("mainContent").innerHTML = html;
}

function renderCategories() {
  const items = DATA.filter(r => r.Project === selProject);
  const groups = {};
  items.forEach(r => { if (!groups[r.Category]) groups[r.Category] = []; groups[r.Category].push(r); });

  let html = "";
  CATEGORIES.forEach(cat => {
    let rows = groups[cat];
    if (!rows) return;
    rows.sort((a,b) => (a.SortOrder||0) - (b.SortOrder||0));

    if (searchQ) {
      rows = rows.filter(r => r.Topic.toLowerCase().includes(searchQ) || (r.Value||"").toLowerCase().includes(searchQ));
      if (!rows.length) return;
    }

    const catId = cat.replace(/[^a-zA-Z]/g, "");
    const isCollapsed = collapsed[cat];
    const cls = CAT_CLASSES[cat] || "cat-general";
    const icon = CAT_ICONS[cat] || "";
    const doneCount = rows.filter(r => r.Complete).length;
    const countStyle = doneCount === rows.length && rows.length > 0 ? "color:#2ecc8a;" : "";

    html += '<div class="cat-section">';
    html += '<div class="cat-header ' + cls + (isCollapsed ? ' collapsed' : '') + '" data-cat="' + esc(cat) + '" onclick="toggleCat(this.dataset.cat)"><span>' + icon + ' ' + esc(cat) + '</span><span style="display:flex;align-items:center;gap:12px;"><span style="font-size:12px;font-weight:600;' + countStyle + '">' + doneCount + '/' + rows.length + '</span><span class="cat-chevron">â–¼</span></span></div>';
    html += '<div class="cat-body' + (isCollapsed ? ' hidden' : '') + '">';

    rows.forEach(r => {
      const val = r.Value || "";
      const emptyCls = val ? "" : " empty";
      const escaped = val.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      const lineCount = Math.max(1, Math.ceil(val.length / 80));
      const key = r.Project + "|" + r.Category + "|" + r.Topic;
      const itemId = spItemMap[key] || "";
      const hasComm = comments[itemId] && comments[itemId].length > 0;

      html += '<div class="topic-row' + (r.Complete ? ' completed' : '') + '">';
      html += '<div class="topic-check"><input type="checkbox" ' + (r.Complete ? 'checked ' : '') + 'data-proj="' + esc(r.Project) + '" data-cat="' + esc(r.Category) + '" data-topic="' + esc(r.Topic) + '" onchange="toggleComplete(this.dataset.proj,this.dataset.cat,this.dataset.topic,this)"></div>';
      html += '<div class="topic-label">' + esc(r.Topic) + '</div>';
      html += '<div class="topic-val"><textarea rows="' + Math.max(1,lineCount) + '" class="' + emptyCls + '" data-proj="' + esc(r.Project) + '" data-cat="' + esc(r.Category) + '" data-topic="' + esc(r.Topic) + '" onblur="onEdit(this.dataset.proj,this.dataset.cat,this.dataset.topic,this)" onfocus="this.classList.remove(&quot;empty&quot;)">' + escaped + '</textarea></div>';
      html += '<div class="comment-btn' + (hasComm ? ' has-comments' : '') + '" data-proj="' + esc(r.Project) + '" data-cat="' + esc(r.Category) + '" data-topic="' + esc(r.Topic) + '" data-itemid="' + itemId + '" onclick="openCommentPanel(this.dataset.proj,this.dataset.cat,this.dataset.topic,this.dataset.itemid)" title="Comments">ğŸ’¬</div>';
      html += '</div>';
    });

    html += '</div></div>';
  });
  return html;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function selectProject(p) { selProject = p; renderAll(); }
function doSearch(q) { searchQ = q.toLowerCase(); document.getElementById("catContent").innerHTML = renderCategories(); }
function toggleCat(cat) {
  collapsed[cat] = !collapsed[cat];
  document.getElementById("catContent").innerHTML = renderCategories();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT + COMPLETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onEdit(project, category, topic, textarea) {
  const key = project + "|" + category + "|" + topic;
  const itemId = spItemMap[key];
  const idx = DATA.findIndex(r => r.Project === project && r.Category === category && r.Topic === topic);
  if (idx >= 0) DATA[idx].Value = textarea.value;
  textarea.className = textarea.value ? "" : "empty";
  if (itemId) queueSave(itemId, "Value", textarea.value);
}

function toggleComplete(project, category, topic, checkbox) {
  const key = project + "|" + category + "|" + topic;
  const itemId = spItemMap[key];
  const idx = DATA.findIndex(r => r.Project === project && r.Category === category && r.Topic === topic);
  if (idx >= 0) DATA[idx].Complete = checkbox.checked;
  const row = checkbox.closest(".topic-row");
  if (checkbox.checked) row.classList.add("completed"); else row.classList.remove("completed");
  if (itemId) queueSave(itemId, "Complete", checkbox.checked);
  // Update counter
  document.getElementById("catContent").innerHTML = renderCategories();
  showToast(checkbox.checked ? "âœ“ Marked complete" : "â†© Reopened", "ok");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMENTS + @MENTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCommentPanel(project, category, topic, itemId) {
  openComment = { project, category, topic, itemId };
  // Load comments from localStorage (or could be SP)
  if (!comments[itemId]) {
    try { comments = JSON.parse(localStorage.getItem("pmo_comments") || "{}"); } catch(e) { comments = {}; }
  }
  renderCommentPanel();
}

function closeCommentPanel() {
  openComment = null;
  document.getElementById("commentPanel").innerHTML = "";
}

function renderCommentPanel() {
  if (!openComment) return;
  const c = openComment;
  const itemComments = comments[c.itemId] || [];

  let html = '<div class="overlay" onclick="closeCommentPanel()"></div>';
  html += '<div class="comment-panel">';
  html += '<div class="comment-panel-head"><div><div class="comment-panel-title">ğŸ’¬ Comments</div><div class="comment-panel-topic">' + c.project + ' â†’ ' + c.topic + '</div></div><button class="comment-close" onclick="closeCommentPanel()">âœ•</button></div>';

  html += '<div class="comment-list" id="commentList">';
  if (itemComments.length === 0) {
    html += '<div style="text-align:center;padding:40px;color:#c4d0dc;font-size:13px;">No comments yet.<br>Type @ to mention someone.</div>';
  } else {
    itemComments.forEach(cm => {
      const text = cm.text.replace(/@(\w[\w\s]*?\w)/g, '<span class="mention">@$1</span>');
      html += '<div class="comment-item"><span class="comment-author">' + cm.author + '</span><span class="comment-time">' + cm.time + '</span><div class="comment-text">' + text + '</div></div>';
    });
  }
  html += '</div>';

  html += '<div class="comment-input-area"><div class="mention-dropdown" id="mentionDropdown"></div>';
  html += '<textarea class="comment-input" id="commentInput" placeholder="Add a comment... Type @ to mention someone" oninput="onCommentInput(this)" onkeydown="onCommentKeydown(event)"></textarea>';
  html += '<button class="comment-send" onclick="sendComment()">Send</button>';
  html += '</div></div>';

  document.getElementById("commentPanel").innerHTML = html;
  setTimeout(() => document.getElementById("commentInput").focus(), 100);
}

let mentionIdx = -1;
let mentionMatches = [];

function onCommentInput(textarea) {
  const val = textarea.value;
  const pos = textarea.selectionStart;
  // Find @ trigger
  const before = val.substring(0, pos);
  const atIdx = before.lastIndexOf("@");

  if (atIdx >= 0 && (atIdx === 0 || before[atIdx-1] === " " || before[atIdx-1] === "\n")) {
    const query = before.substring(atIdx + 1).toLowerCase();
    if (query.length >= 0 && !query.includes(" ") || query.split(" ").length <= 2) {
      mentionMatches = TEAM.filter(t => t.name.toLowerCase().includes(query) || t.nick.toLowerCase().includes(query)).slice(0, 6);
      if (mentionMatches.length > 0) {
        mentionIdx = 0;
        renderMentionDropdown();
        return;
      }
    }
  }
  hideMentionDropdown();
}

function onCommentKeydown(e) {
  const dd = document.getElementById("mentionDropdown");
  if (!dd.classList.contains("show")) return;

  if (e.key === "ArrowDown") { e.preventDefault(); mentionIdx = Math.min(mentionIdx + 1, mentionMatches.length - 1); renderMentionDropdown(); }
  else if (e.key === "ArrowUp") { e.preventDefault(); mentionIdx = Math.max(mentionIdx - 1, 0); renderMentionDropdown(); }
  else if (e.key === "Enter" || e.key === "Tab") {
    if (mentionMatches.length > 0) { e.preventDefault(); insertMention(mentionMatches[mentionIdx]); }
  }
  else if (e.key === "Escape") { hideMentionDropdown(); }
}

function renderMentionDropdown() {
  const dd = document.getElementById("mentionDropdown");
  dd.innerHTML = mentionMatches.map((t, i) => {
    const initials = t.name.split(" ").map(n => n[0]).join("").substring(0, 2);
    return '<div class="mention-item' + (i === mentionIdx ? ' selected' : '') + '" data-email="' + esc(t.email) + '" onclick="insertMention(TEAM.find(function(x){return x.email===this.dataset.email}.bind(this)))"><div class="mention-avatar">' + initials + '</div><div><div class="mention-name">' + esc(t.name) + '</div><div class="mention-email">' + esc(t.email) + '</div></div></div>';
  }).join("");
  dd.classList.add("show");
}

function hideMentionDropdown() {
  const dd = document.getElementById("mentionDropdown");
  if (dd) dd.classList.remove("show");
  mentionIdx = -1;
  mentionMatches = [];
}

function insertMention(person) {
  const textarea = document.getElementById("commentInput");
  const val = textarea.value;
  const pos = textarea.selectionStart;
  const before = val.substring(0, pos);
  const atIdx = before.lastIndexOf("@");
  const after = val.substring(pos);

  textarea.value = before.substring(0, atIdx) + "@" + person.name + " " + after;
  textarea.selectionStart = textarea.selectionEnd = atIdx + person.name.length + 2;
  textarea.focus();
  hideMentionDropdown();
}

async function sendComment() {
  if (!openComment) return;
  const textarea = document.getElementById("commentInput");
  const text = textarea.value.trim();
  if (!text) return;

  const c = openComment;
  const now = new Date();
  const timeStr = now.toLocaleDateString() + " " + now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  // Save comment locally
  if (!comments[c.itemId]) comments[c.itemId] = [];
  comments[c.itemId].push({ author: currentUser || "You", text, time: timeStr });
  localStorage.setItem("pmo_comments", JSON.stringify(comments));

  // Find @mentions and send Teams messages
  const mentions = text.match(/@([\w][\w\s-]*[\w])/g);
  if (mentions) {
    for (const m of mentions) {
      const name = m.substring(1).trim();
      const person = TEAM.find(t => t.name.toLowerCase() === name.toLowerCase());
      if (person) {
        sendTeamsMessage(person, c, text);
      }
    }
  }

  renderCommentPanel();
  // Scroll to bottom
  const list = document.getElementById("commentList");
  if (list) list.scrollTop = list.scrollHeight;

  // Update comment icon
  document.getElementById("catContent").innerHTML = renderCategories();
}

async function sendTeamsMessage(person, context, commentText) {
  try {
    // Get the user's ID from their email
    const user = await graph("GET", "/users/" + encodeURIComponent(person.email));
    const userId = user.id;

    // Get current user ID
    const me = await graph("GET", "/me");

    // Create 1:1 chat
    const chat = await graph("POST", "/chats", {
      chatType: "oneOnOne",
      members: [
        { "@odata.type": "#microsoft.graph.aadUserConversationMember", roles: ["owner"], "user@odata.bind": "https://graph.microsoft.com/v1.0/users('" + me.id + "')" },
        { "@odata.type": "#microsoft.graph.aadUserConversationMember", roles: ["owner"], "user@odata.bind": "https://graph.microsoft.com/v1.0/users('" + userId + "')" }
      ]
    });

    // Send message
    const msgBody = "ğŸ“‹ <b>PMO Update â€” " + context.project + "</b><br>" +
      "<b>" + context.topic + "</b> (" + context.category + ")<br><br>" +
      commentText.replace(/@([\w][\w\s-]*[\w])/g, '<b>@$1</b>') +
      "<br><br><i>â€” " + (currentUser || "PMO Dashboard") + "</i>";

    await graph("POST", "/chats/" + chat.id + "/messages", {
      body: { contentType: "html", content: msgBody }
    });

    showToast("ğŸ’¬ Teams message sent to " + person.name, "ok");
  } catch (e) {
    console.error("Teams msg failed:", e);
    showToast("Teams notification failed: " + e.message, "err");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "toast show " + (type || "ok");
  setTimeout(() => t.classList.remove("show"), 2500);
}

// Init
initAuth();
</script>
</body>
</html>
